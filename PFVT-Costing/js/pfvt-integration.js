/**
 * IBM MAS PFVT Cost and Sizing Advisor
 * PFVT Integration Module
 */

const PFVT_REPO_URL = 'https://github.ibm.com/maximoappsuite/fvt-personal.git';
const TEKTON_PIPELINE_URL = 'https://cloud.ibm.com/devops/pipelines/tekton/3612e317-4d13-42a4-b798-d7db422549f8/runs?env_id=ibm:yp:us-south&view=logs&triggerName=fvt%3A+fvt-personal';
const API_BASE_URL = 'http://localhost:3001/api';

// Check if backend API is available
let apiAvailable = false;

async function checkAPIAvailability() {
    try {
        const response = await fetch(`${API_BASE_URL}/health`, { timeout: 2000 });
        apiAvailable = response.ok;
        return apiAvailable;
    } catch (error) {
        apiAvailable = false;
        return false;
    }
}

// Check API on load
checkAPIAvailability();

/**
 * Generate cluster.env file content from configuration
 * @param {object} results - Calculation results
 * @returns {string} cluster.env file content
 */
function generateClusterEnv(results) {
    const config = results.configuration;
    const flavor = results.flavor;
    const zones = results.zones;
    const timestamp = new Date().toISOString();
    
    const envContent = `# cluster.env
# Generated by IBM MAS PFVT Cost & Sizing Advisor
# Timestamp: ${timestamp}
# Configuration: ${config.name}
# Cost Score: ${results.costScore.score}
# Estimated Monthly Cost: $${results.costs.costs.total.monthly.toFixed(2)}

# A. Re-use an existing cluster
# =============================================================================
# Set to CLUSTER_REUSE="true" to work with an existing cluster
# Define the cluster to reuse by setting CLUSTER_TYPE and CLUSTER_NAME
# When CLUSTER_REUSE is true no other values are required
# CLUSTER_REUSE="true"
# CLUSTER_TYPE=fyre|roks
# CLUSTER_NAME=pfvt-xxx


# B. Use a new cluster
# =============================================================================

# Cluster Configuration
# -----------------------------------------------------------------------------
# OCP_VERSION=rotate|4.16|4.17|4.18
CLUSTER_TYPE=roks
# FYRE_SITE=svl|rtp
# ROKS_ZONE=dal10

# Worker Pool Configuration (ROKS)
# -----------------------------------------------------------------------------
ROKS_WORKERS=${config.workers}
ROKS_FLAVOR=${flavor.name}

# Worker Pool Configuration (Fyre)
# -----------------------------------------------------------------------------
# FYRE_WORKER_COUNT=3
# FYRE_WORKER_CPU=8
# FYRE_WORKER_MEMORY=16

# Business Case
# -----------------------------------------------------------------------------
# FYRE_CLUSTER_DESCRIPTION="Testing FVT Pipeline"

# Business Justification - REQUIRED
# -----------------------------------------------------------------------------
BUSINESS_JUSTIFICATION="MAS ${config.name} deployment - ${zones} zone(s), ${config.workers} workers, ${flavor.name} flavor"

# =============================================================================
# Cost Estimation (Reference Only - Generated by Cost & Sizing Advisor)
# =============================================================================
# Total Nodes: ${config.workers * zones} (${config.workers} workers √ó ${zones} zones)
# Worker Flavor: ${flavor.name} (${flavor.vcpu} vCPU, ${flavor.ram}GB RAM)
# Hourly Cost: $${results.costs.costs.total.hourly.toFixed(2)}
# Monthly Cost: $${results.costs.costs.total.monthly.toFixed(2)}
# Yearly Cost: $${results.costs.costs.total.yearly.toFixed(2)}
# PFVT Cost Score: ${results.costScore.score}
`;

    return envContent;
}

/**
 * Generate mas.env file content from configuration
 * @param {object} results - Calculation results
 * @returns {string} mas.env file content
 */
function generateMasEnv(results) {
    const config = results.configuration;
    const timestamp = new Date().toISOString();
    
    // Determine which apps to enable based on configuration
    const hasManage = config.components.includes('manage');
    const hasAssist = config.components.includes('assist');
    const hasIoT = config.components.includes('iot');
    const hasMonitor = config.components.includes('monitor');
    const hasPredict = config.components.includes('predict');
    const hasMVI = config.components.includes('mvi');
    
    const envContent = `# mas.env
# Generated by IBM MAS PFVT Cost & Sizing Advisor
# Timestamp: ${timestamp}
# Configuration: ${config.name}
# Components: ${config.components.join(', ')}

# MAS Install
# -----------------------------------------------------------------------------
MAS_CATALOG_VERSION=v9-master-amd64

MAS_INSTANCE_ID=\${TRAVIS_BRANCH}
MAS_CHANNEL=9.2.x-dev

# MAS Application Channels
# -----------------------------------------------------------------------------
${hasAssist ? 'MAS_APP_CHANNEL_ASSIST=9.2.x-dev' : '# MAS_APP_CHANNEL_ASSIST=9.2.x-dev'}
${hasIoT ? 'MAS_APP_CHANNEL_IOT=9.2.x-dev' : '# MAS_APP_CHANNEL_IOT=9.2.x-dev'}
${hasMonitor ? 'MAS_APP_CHANNEL_MONITOR=9.2.x-dev' : '# MAS_APP_CHANNEL_MONITOR=9.2.x-dev'}
${hasPredict ? 'MAS_APP_CHANNEL_OPTIMIZER=9.2.x-dev' : '# MAS_APP_CHANNEL_OPTIMIZER=9.2.x-dev'}
${hasMVI ? 'MAS_APP_CHANNEL_VISUALINSPECTION=9.2.x-dev' : '# MAS_APP_CHANNEL_VISUALINSPECTION=9.2.x-dev'}
${hasManage ? 'MAS_APP_CHANNEL_MANAGE=9.2.x-dev' : '# MAS_APP_CHANNEL_MANAGE=9.2.x-dev'}

# Manage Configuration
# -----------------------------------------------------------------------------
# MANAGE_COMPONENTS="base=latest"
# MANAGE_ADD_CUSTOMIZATION=true
# MANAGE_ATTACHMENT_CONFIG=true
# MANAGE_NO_COS=true
# MAS_APP_SETTINGS_DEFAULT_JMS=true
# MAS_APP_SETTINGS_SERVER_BUNDLES_SIZE=jms
# MAS_APP_SETTINGS_PERSISTENT_VOLUMES_FLAG=true

# Optimizer Configuration
# -----------------------------------------------------------------------------
# OPTIMIZER_PLAN="full"


# Manual Certificate Mgmt & CIS DNS Integration
# -----------------------------------------------------------------------------
# MAS_CERTS_DIR=$MAS_HOME_DIR/certs
# DNS_PROVIDER=cis


# Configure External Manage DB
# -----------------------------------------------------------------------------
# SETUP_EXTERNAL_DB=true
# MANAGE_EXT_DB_CONFIG=true
# MANAGE_EXT_DB_HOST=inv01db1.fyre.ibm.com
# MANAGE_EXT_DB_JDBC_FILE_CFG=jdbc_inv01.yaml
# MAS_APP_SETTINGS_TABLESPACE=maxdata
# MAS_APP_SETTINGS_INDEXSPACE=maxindx
# MAS_APP_SETTINGS_DB_SCHEMA=maximo
# MAS_APPWS_BINDINGS_JDBC_MANAGE=system


# MAS Dependencies
# -----------------------------------------------------------------------------
# KAFKA_PROVIDER=ibm
# EVENTSTREAMS_RESOURCEGROUP=$IBMCLOUD_RESOURCEGROUP
# EVENTSTREAMS_NAME=event-streams-$MAS_INSTANCE_ID
# EVENTSTREAMS_LOCATION=us-south

# CP4D_VERSION=5.1.3


# FVT Launcher
# -----------------------------------------------------------------------------
# SETUP_MANAGE=true

# LAUNCHFVT_MONITOR=true
# LAUNCHFVT_MANAGE=true
# LAUNCHFVT_MANAGE_IS=true
# LAUNCHFVT_MOBILE=true
# LAUNCHFVT_OPTIMIZER=true
# LAUNCHFVT_VISUALINSPECTION=true
# LAUNCHFVT_ASSIST=true
# LAUNCHIVT_MANAGE=true

# FVT_ENABLE_IMAGE_SCAN=true
`;

    return envContent;
}

/**
 * Download file
 * @param {string} content - File content
 * @param {string} filename - File name
 */
function downloadFile(content, filename) {
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

/**
 * Generate Git commands for user
 * @param {string} branchName - Git branch name
 * @returns {string} Git commands
 */
function generateGitCommands(branchName = 'feature/pfvt-config') {
    return `# Step 1: Clone repository (if not already cloned)
git clone ${PFVT_REPO_URL}
cd fvt-personal

# Step 2: Create/checkout your branch
git checkout -b ${branchName}

# Step 3: Copy the downloaded files to the repository
cp ~/Downloads/cluster.env .
cp ~/Downloads/mas.env .

# Step 4: Commit and push changes
git add cluster.env mas.env
git commit -m "Update PFVT configuration from Cost & Sizing Advisor"
git push origin ${branchName}

# Step 5: Tekton pipeline will automatically trigger!
# Monitor pipeline at: ${TEKTON_PIPELINE_URL}`;
}

/**
 * Generate configuration summary
 * @param {object} results - Calculation results
 * @returns {string} Summary text
 */
function generateConfigSummary(results) {
    const config = results.configuration;
    const flavor = results.flavor;
    const zones = results.zones;
    
    return `Configuration: ${config.name}
Components: ${config.components.join(', ')}
Worker Flavor: ${flavor.name} (${flavor.vcpu} vCPU, ${flavor.ram}GB RAM)
Zones: ${zones}
Total Nodes: ${config.workers * zones}
Cost Score: ${results.costScore.score}`;
}

/**
 * Show PFVT integration in side panel
 * @param {object} results - Calculation results
 */
function showPFVTModal(results) {
    const clusterEnv = generateClusterEnv(results);
    const masEnv = generateMasEnv(results);
    const summary = generateConfigSummary(results);
    
    // Store env content for download
    window.currentClusterEnv = clusterEnv;
    window.currentMasEnv = masEnv;
    window.currentResults = results;
    
    // Create panel content HTML
    const panelContent = `
        <div class="pfvt-section">
            <h3>üìã Configuration Summary</h3>
            <pre class="config-summary">${summary}</pre>
        </div>
        
        <div class="pfvt-section" style="background: #e3f2fd; border-left-color: #2196f3;">
            <h3>üìÇ Repository File Paths</h3>
            <p>Copy these files to your <code>fvt-personal</code> repository:</p>
            <div style="background: white; padding: 1rem; border-radius: 6px; margin-top: 0.5rem;">
                <div style="margin-bottom: 0.5rem;">
                    <strong>üìÑ cluster.env</strong> ‚Üí <code style="background: #f5f5f5; padding: 0.2rem 0.5rem; border-radius: 3px;">./cluster.env</code>
                </div>
                <div>
                    <strong>üìÑ mas.env</strong> ‚Üí <code style="background: #f5f5f5; padding: 0.2rem 0.5rem; border-radius: 3px;">./mas.env</code>
                </div>
            </div>
        </div>
        
        <div class="pfvt-section">
            <h3>‚¨áÔ∏è Download Configuration Files</h3>
            <p>Download both files to copy into your repository:</p>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="downloadClusterEnv()">
                    <span class="icon">üì•</span> Download cluster.env
                </button>
                <button class="btn btn-primary" onclick="downloadMasEnv()">
                    <span class="icon">üì•</span> Download mas.env
                </button>
                <button class="btn btn-success" onclick="downloadBothEnvFiles()">
                    <span class="icon">üì¶</span> Download Both Files
                </button>
            </div>
        </div>
        
        <div class="pfvt-section">
            <h3>üìÑ File Previews</h3>
            <p><strong>cluster.env</strong> preview:</p>
            <textarea class="env-preview" readonly rows="8" id="clusterEnvPreview">${clusterEnv}</textarea>
            <p style="margin-top: 1rem;"><strong>mas.env</strong> preview:</p>
            <textarea class="env-preview" readonly rows="8" id="masEnvPreview">${masEnv}</textarea>
        </div>
        
        <div class="pfvt-section">
            <h3>üîß Git Commands (You Run These)</h3>
            <p>After copying files to your repo, run these commands:</p>
            <div class="git-commands-container">
                <textarea class="git-commands" readonly rows="10" id="gitCommands"># Navigate to your repo
cd /path/to/fvt-personal

# Copy downloaded files to repo root
cp ~/Downloads/cluster.env .
cp ~/Downloads/mas.env .

# Commit and push (you choose your branch name)
git add cluster.env mas.env
git commit -m "Update PFVT config - ${results.configuration.name}"
git push origin your-branch-name</textarea>
                <button class="btn btn-secondary copy-btn" onclick="copyGitCommands()">
                    <span class="icon">üìã</span> Copy Commands
                </button>
            </div>
        </div>
        
        <div class="pfvt-section">
            <h3>üîó Monitor Pipeline</h3>
            <p>After pushing, the Tekton pipeline will automatically trigger.</p>
            <div class="pipeline-links">
                <a href="${PFVT_REPO_URL}" target="_blank" class="btn-link">
                    <span class="icon">üì¶</span> Open Repository
                </a>
                <a href="${TEKTON_PIPELINE_URL}" target="_blank" class="btn-link">
                    <span class="icon">üîÑ</span> View Pipeline
                </a>
            </div>
        </div>
    `;
    
    // Update panel content
    const panelContentEl = document.getElementById('pfvt-panel-content');
    if (panelContentEl) {
        panelContentEl.innerHTML = panelContent;
    }
    
    // Show panel and overlay
    const panel = document.getElementById('pfvt-side-panel');
    const overlay = document.getElementById('pfvt-panel-overlay');
    
    if (panel && overlay) {
        panel.classList.add('active');
        overlay.classList.add('active');
    }
}

/**
 * Close PFVT side panel
 */
function closePFVTPanel() {
    const panel = document.getElementById('pfvt-side-panel');
    const overlay = document.getElementById('pfvt-panel-overlay');
    
    if (panel) {
        panel.classList.remove('active');
    }
    if (overlay) {
        overlay.classList.remove('active');
    }
}

/**
 * Close PFVT modal (legacy - now redirects to panel close)
 */
function closePFVTModal() {
    closePFVTPanel();
}
                    

/**
 * Close PFVT modal
 */
function closePFVTModal() {
    const modal = document.getElementById('pfvtModal');
    if (modal) {
        modal.remove();
    }
}

/**
 * Download cluster.env file
 */
function downloadClusterEnv() {
    if (window.currentClusterEnv) {
        downloadFile(window.currentClusterEnv, 'cluster.env');
        showNotification('‚úÖ cluster.env downloaded successfully!', 'success');
    }
}

/**
 * Download mas.env file
 */
function downloadMasEnv() {
    if (window.currentMasEnv) {
        downloadFile(window.currentMasEnv, 'mas.env');
        showNotification('‚úÖ mas.env downloaded successfully!', 'success');
    }
}

/**
 * Download both env files
 */
function downloadBothEnvFiles() {
    downloadClusterEnv();
    setTimeout(() => downloadMasEnv(), 500);
}

/**
 * Copy Git commands to clipboard
 */
function copyGitCommands() {
    const textarea = document.getElementById('gitCommands');
    textarea.select();
    document.execCommand('copy');
    showNotification('‚úÖ Git commands copied to clipboard!', 'success');
}

/**
 * Show notification
 * @param {string} message - Notification message
 * @param {string} type - Notification type (success, error, info)
 */
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;

/**
 * Deploy configuration via API (one-click deployment)
 * @param {object} results - Calculation results
 * @param {string} branchName - Git branch name
 */
async function deployViaAPI(results, branchName = 'feature/pfvt-config') {
    try {
        showNotification('üöÄ Deploying to GitHub...', 'info');
        
        const clusterEnv = generateClusterEnv(results);
        const masEnv = generateMasEnv(results);
        
        const payload = {
            clusterEnv,
            masEnv,
            branchName,
            commitMessage: `Update PFVT configuration - ${results.configuration.name}`,
            configuration: {
                name: results.configuration.name,
                workers: results.configuration.workers,
                flavor: results.flavor.name,
                zones: results.zones,
                costScore: results.costScore.score,
                monthlyCost: results.costs.costs.total.monthly,
                components: results.configuration.components
            }
        };
        
        const response = await fetch(`${API_BASE_URL}/deploy`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });
        
        if (!response.ok) {
            throw new Error(`API error: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        // Show success with links
        showDeploymentSuccess(data);
        
        return data;
    } catch (error) {
        console.error('API deployment failed:', error);
        showNotification('‚ùå API deployment failed. Using manual method.', 'error');
        // Fallback to manual download
        showPFVTModal(results);
        return null;
    }
}

/**
 * Show deployment success modal
 * @param {object} data - Deployment response data
 */
function showDeploymentSuccess(data) {
    const modalHTML = `
        <div class="modal-overlay" id="deploySuccessModal">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2>‚úÖ Deployment Successful!</h2>
                    <button class="modal-close" onclick="closeDeploySuccessModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="success-message">
                        <p style="font-size: 1.1rem; margin-bottom: 1.5rem;">
                            Your PFVT configuration has been deployed to GitHub!
                        </p>
                        
                        <div class="deployment-info">
                            <div class="info-item">
                                <strong>Branch:</strong> ${data.branch}
                            </div>
                            ${data.prUrl ? `
                            <div class="info-item">
                                <strong>Pull Request:</strong> 
                                <a href="${data.prUrl}" target="_blank">View PR</a>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="action-buttons" style="margin-top: 2rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                            <a href="${data.repoUrl}" target="_blank" class="btn btn-primary">
                                üì¶ View Repository
                            </a>
                            <a href="${data.pipelineUrl}" target="_blank" class="btn btn-success">
                                üîÑ Monitor Pipeline
                            </a>
                        </div>
                        
                        <div class="next-steps" style="margin-top: 2rem; padding: 1rem; background: #f8f9fa; border-radius: 6px;">
                            <h4>Next Steps:</h4>
                            <ol style="margin: 0.5rem 0 0 1.5rem;">
                                <li>Review the pull request</li>
                                <li>Merge when ready</li>
                                <li>Monitor Tekton pipeline execution</li>
                                <li>Check test results</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

/**
 * Close deployment success modal
 */
function closeDeploySuccessModal() {
    const modal = document.getElementById('deploySuccessModal');
    if (modal) {
        modal.remove();
    }
}

/**
 * Show simplified PFVT modal - manual workflow only
 */
function showPFVTModalEnhanced(results) {
    const clusterEnv = generateClusterEnv(results);
    const masEnv = generateMasEnv(results);
    const summary = generateConfigSummary(results);
    
    // Store env content for download
    window.currentClusterEnv = clusterEnv;
    window.currentMasEnv = masEnv;
    window.currentResults = results;
    
    const modalHTML = `
        <div class="modal-overlay" id="pfvtModal">
            <div class="modal-content pfvt-modal">
                <div class="modal-header">
                    <h2>üöÄ PFVT Integration - Manual Workflow</h2>
                    <button class="modal-close" onclick="closePFVTModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="pfvt-section">
                        <h3>üìã Configuration Summary</h3>
                        <pre class="config-summary">${summary}</pre>
                    </div>
                    
                    <div class="pfvt-section" style="background: #e3f2fd; border-left-color: #2196f3;">
                        <h3>üìÇ Step 1: Repository File Paths</h3>
                        <p>Copy these files to your <code>fvt-personal</code> repository:</p>
                        <div style="background: white; padding: 1rem; border-radius: 6px; margin-top: 0.5rem;">
                            <div style="margin-bottom: 0.5rem;">
                                <strong>üìÑ cluster.env</strong> ‚Üí <code style="background: #f5f5f5; padding: 0.2rem 0.5rem; border-radius: 3px;">./cluster.env</code>
                            </div>
                            <div>
                                <strong>üìÑ mas.env</strong> ‚Üí <code style="background: #f5f5f5; padding: 0.2rem 0.5rem; border-radius: 3px;">./mas.env</code>
                            </div>
                        </div>
                    </div>
                    
                    <div class="pfvt-section">
                        <h3>‚¨áÔ∏è Step 2: Download Configuration Files</h3>
                        <p>Download both files to copy into your repository:</p>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="downloadClusterEnv()">
                                <span class="icon">üì•</span> Download cluster.env
                            </button>
                            <button class="btn btn-primary" onclick="downloadMasEnv()">
                                <span class="icon">üì•</span> Download mas.env
                            </button>
                            <button class="btn btn-success" onclick="downloadBothEnvFiles()">
                                <span class="icon">üì¶</span> Download Both Files
                            </button>
                        </div>
                    </div>
                    
                    <div class="pfvt-section">
                        <h3>üìÑ File Previews</h3>
                        <details style="margin-bottom: 1rem;">
                            <summary style="cursor: pointer; font-weight: 600; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
                                cluster.env
                            </summary>
                            <textarea class="env-preview" readonly rows="8" style="margin-top: 0.5rem;">${clusterEnv}</textarea>
                        </details>
                        <details>
                            <summary style="cursor: pointer; font-weight: 600; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
                                mas.env
                            </summary>
                            <textarea class="env-preview" readonly rows="8" style="margin-top: 0.5rem;">${masEnv}</textarea>
                        </details>
                    </div>
                    
                    <div class="pfvt-section">
                        <h3>üîó Quick Links</h3>
                        <div class="pipeline-links">
                            <a href="${PFVT_REPO_URL}" target="_blank" class="btn btn-link">
                                <span class="icon">üì¶</span> Open Repository
                            </a>
                            <a href="${TEKTON_PIPELINE_URL}" target="_blank" class="btn btn-link">
                                <span class="icon">üîÑ</span> View Pipeline
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if present
    const existingModal = document.getElementById('pfvtModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

/**
 * Handle API deployment button click
 */
async function handleAPIDeployment() {
    const branchName = document.getElementById('api-branch-name')?.value || 'feature/pfvt-config';
    
    if (!window.currentResults) {
        showNotification('‚ùå No configuration data available', 'error');
        return;
    }
    
    closePFVTModal();
    await deployViaAPI(window.currentResults, branchName);
}

// Replace the original showPFVTModal with enhanced version
const originalShowPFVTModal = showPFVTModal;
showPFVTModal = showPFVTModalEnhanced;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.classList.add('show');
    }, 10);
    
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Made with Bob
